<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>PortalHub Creator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #475569;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #475569;
            --shadow: rgba(0, 0, 0, 0.25);
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: var(--background);
            color: var(--text-primary);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            padding: 24px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        .app-container {
            width: 100%;
            max-width: 900px;
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 25px var(--shadow);
            overflow: hidden;
        }
        
        .app-header {
            padding: 32px 32px 24px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
        }
        
        .app-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(90deg, var(--primary), #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .app-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 400;
        }
        
        .app-content {
            padding: 32px;
        }
        
        .progress-container {
            display: flex;
            margin-bottom: 40px;
            position: relative;
        }
        
        .progress-line {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 2px;
            background: var(--border);
            z-index: 1;
        }
        
        .progress-step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--surface-light);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            transition: var(--transition);
        }
        
        .step-circle.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .step-circle.completed {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .step-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            text-align: center;
        }
        
        .step-label.active {
            color: var(--text-primary);
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        .section-description {
            color: var(--text-secondary);
            margin-bottom: 24px;
            font-size: 14px;
        }
        
        .folder-selector {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 40px 24px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(30, 41, 59, 0.5);
        }
        
        .folder-selector:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }
        
        .folder-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--primary);
        }
        
        .folder-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .folder-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .folder-button {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 500;
            transition: var(--transition);
            border: none;
            cursor: pointer;
        }
        
        .folder-button:hover {
            background: var(--primary-dark);
        }
        
        .selected-folder {
            margin-top: 20px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary);
        }
        
        .folder-path {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            color: var(--text-primary);
            word-break: break-all;
        }
        
        .file-count {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 15px;
            transition: var(--transition);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--text-secondary);
        }
        
        .form-hint {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 6px;
        }
        
        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }
        
        .button {
            padding: 14px 28px;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-family: inherit;
        }
        
        .button-primary {
            background: var(--primary);
            color: white;
            flex: 1;
        }
        
        .button-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }
        
        .button-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .button-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .log-container {
            margin-top: 32px;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .log-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .clear-log {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .clear-log:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .log-box {
            height: 300px;
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.7);
            border-radius: var(--radius-md);
            padding: 20px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            border: 1px solid var(--border);
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }
        
        .log-entry:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        .log-time {
            color: var(--text-secondary);
            font-size: 12px;
            margin-right: 10px;
        }
        
        .log-message {
            color: var(--text-primary);
        }
        
        .log-message.success {
            color: var(--success);
        }
        
        .log-message.error {
            color: var(--error);
        }
        
        .log-message.warning {
            color: var(--warning);
        }
        
        .log-message.info {
            color: var(--primary);
        }
        
        .status-summary {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            border-left: 4px solid var(--primary);
        }
        
        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .status-icon.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .status-icon.ready {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .status-text {
            font-size: 14px;
        }
        
        .files-preview {
            margin-top: 24px;
        }
        
        .files-list {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.5);
            border-radius: var(--radius-md);
            padding: 16px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
        }
        
        .file-item {
            padding: 6px 0;
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 16px;
            }
            
            .app-header, .app-content {
                padding: 24px 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .progress-step {
                min-width: 80px;
            }
            
            .step-label {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1 class="app-title">PortalHub Creator</h1>
            <p class="app-subtitle">Despliega estructuras de carpetas en repositorios GitHub</p>
        </header>
        
        <div class="app-content">
            <!-- Progress Steps -->
            <div class="progress-container">
                <div class="progress-line"></div>
                
                <div class="progress-step">
                    <div class="step-circle active" id="step1-circle">1</div>
                    <div class="step-label active">Seleccionar Carpeta</div>
                </div>
                
                <div class="progress-step">
                    <div class="step-circle" id="step2-circle">2</div>
                    <div class="step-label">Configurar GitHub</div>
                </div>
                
                <div class="progress-step">
                    <div class="step-circle" id="step3-circle">3</div>
                    <div class="step-label">Desplegar</div>
                </div>
            </div>
            
            <!-- Step 1: Folder Selection -->
            <div class="step-content active" id="step1-content">
                <h2 class="section-title">Seleccionar Carpeta Local</h2>
                <p class="section-description">Selecciona la carpeta que contiene la estructura que deseas desplegar en GitHub.</p>
                
                <div class="folder-selector" id="folderSelector">
                    <div class="folder-icon">üìÅ</div>
                    <h3 class="folder-title">Seleccionar Carpeta</h3>
                    <p class="folder-subtitle">Haz clic para explorar y seleccionar una carpeta de tu dispositivo</p>
                    <div class="folder-button">Examinar Carpeta</div>
                </div>
                
                <div class="selected-folder" id="selectedFolder" style="display: none;">
                    <div class="folder-path" id="folderPath"></div>
                    <div class="file-count" id="fileCount"></div>
                </div>
                
                <div class="files-preview" id="filesPreview" style="display: none;">
                    <h3 class="section-title">Vista Previa de Archivos</h3>
                    <div class="files-list" id="filesList"></div>
                </div>
                
                <div class="action-buttons">
                    <button class="button button-secondary" onclick="previousStep()" style="visibility: hidden;">Anterior</button>
                    <button class="button button-primary" onclick="nextStep()" id="nextStep1">Siguiente: Configuraci√≥n GitHub</button>
                </div>
            </div>
            
            <!-- Step 2: GitHub Configuration -->
            <div class="step-content" id="step2-content">
                <h2 class="section-title">Configuraci√≥n de GitHub</h2>
                <p class="section-description">Proporciona tus credenciales de GitHub y los detalles del repositorio.</p>
                
                <div class="form-group">
                    <label class="form-label" for="githubToken">Token de Acceso Personal de GitHub</label>
                    <input type="password" class="form-input" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                    <p class="form-hint">Necesitas un token con permisos "repo" para acceder a repositorios. <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--primary); text-decoration: none;">Generar token</a></p>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="repoOwner">Propietario del Repositorio</label>
                    <input type="text" class="form-input" id="repoOwner" placeholder="nombre-usuario-o-organizacion" />
                    <p class="form-hint">Tu nombre de usuario de GitHub o el nombre de la organizaci√≥n.</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="repoName">Nombre del Repositorio</label>
                    <input type="text" class="form-input" id="repoName" placeholder="nombre-repositorio" />
                    <p class="form-hint">Nombre del repositorio donde se desplegar√° la estructura.</p>
                </div>
                
                <div class="status-summary" id="configStatus">
                    <div class="status-icon pending">
                        <span>!</span>
                    </div>
                    <div class="status-text">Completa todos los campos para continuar.</div>
                </div>
                
                <div class="action-buttons">
                    <button class="button button-secondary" onclick="previousStep()">Anterior</button>
                    <button class="button button-primary" onclick="nextStep()" id="nextStep2" disabled>Siguiente: Revisar y Desplegar</button>
                </div>
            </div>
            
            <!-- Step 3: Deploy -->
            <div class="step-content" id="step3-content">
                <h2 class="section-title">Revisar y Desplegar</h2>
                <p class="section-description">Revisa la configuraci√≥n y despliega la estructura en GitHub.</p>
                
                <div class="status-summary" id="deployStatus">
                    <div class="status-icon pending">
                        <span>!</span>
                    </div>
                    <div class="status-text">Listo para desplegar. Revisa la configuraci√≥n a continuaci√≥n.</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Resumen de la Configuraci√≥n</label>
                    <div style="background: rgba(15, 23, 42, 0.7); border-radius: var(--radius-md); padding: 20px;">
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 13px; color: var(--text-secondary);">Carpeta seleccionada:</div>
                            <div id="summaryFolder" style="font-family: 'Monaco', 'Consolas', monospace; font-size: 14px; margin-top: 4px;">-</div>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 13px; color: var(--text-secondary);">Archivos a desplegar:</div>
                            <div id="summaryFiles" style="font-family: 'Monaco', 'Consolas', monospace; font-size: 14px; margin-top: 4px;">0</div>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 13px; color: var(--text-secondary);">Repositorio de destino:</div>
                            <div id="summaryRepo" style="font-family: 'Monaco', 'Consolas', monospace; font-size: 14px; margin-top: 4px;">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="button button-secondary" onclick="previousStep()">Anterior</button>
                    <button class="button button-primary" onclick="deployToGitHub()" id="deployButton">Iniciar Despliegue</button>
                </div>
                
                <div class="log-container">
                    <div class="log-header">
                        <h3 class="log-title">Registro de Actividad</h3>
                        <button class="clear-log" onclick="clearLog()">Limpiar Registro</button>
                    </div>
                    <div class="log-box" id="logBox"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        const state = {
            currentStep: 1,
            selectedFolder: null,
            files: [],
            folderName: '',
            githubToken: '',
            repoOwner: '',
            repoName: ''
        };

        // DOM Elements
        const stepCircles = [
            document.getElementById('step1-circle'),
            document.getElementById('step2-circle'),
            document.getElementById('step3-circle')
        ];
        
        const stepContents = [
            document.getElementById('step1-content'),
            document.getElementById('step2-content'),
            document.getElementById('step3-content')
        ];
        
        const folderSelector = document.getElementById('folderSelector');
        const selectedFolder = document.getElementById('selectedFolder');
        const folderPath = document.getElementById('folderPath');
        const fileCount = document.getElementById('fileCount');
        const filesPreview = document.getElementById('filesPreview');
        const filesList = document.getElementById('filesList');
        
        const githubTokenInput = document.getElementById('githubToken');
        const repoOwnerInput = document.getElementById('repoOwner');
        const repoNameInput = document.getElementById('repoName');
        
        const nextStep1Button = document.getElementById('nextStep1');
        const nextStep2Button = document.getElementById('nextStep2');
        const deployButton = document.getElementById('deployButton');
        
        const summaryFolder = document.getElementById('summaryFolder');
        const summaryFiles = document.getElementById('summaryFiles');
        const summaryRepo = document.getElementById('summaryRepo');
        
        const logBox = document.getElementById('logBox');
        
        // Initialize event listeners
        function init() {
            folderSelector.addEventListener('click', selectFolder);
            
            githubTokenInput.addEventListener('input', validateStep2);
            repoOwnerInput.addEventListener('input', validateStep2);
            repoNameInput.addEventListener('input', validateStep2);
            
            log('PortalHub Creator iniciado. Selecciona una carpeta para comenzar.', 'info');
        }
        
        // Step navigation
        function nextStep() {
            if (state.currentStep < 3) {
                // Validate current step before proceeding
                if (state.currentStep === 1 && state.files.length === 0) {
                    log('Por favor, selecciona una carpeta antes de continuar.', 'warning');
                    return;
                }
                
                if (state.currentStep === 2 && !validateStep2()) {
                    log('Por favor, completa todos los campos de configuraci√≥n de GitHub.', 'warning');
                    return;
                }
                
                // Update step 3 summary if moving to final step
                if (state.currentStep === 2) {
                    updateDeploymentSummary();
                }
                
                // Hide current step
                stepContents[state.currentStep - 1].classList.remove('active');
                stepCircles[state.currentStep - 1].classList.remove('active');
                
                // Update current step
                state.currentStep++;
                
                // Show next step
                stepContents[state.currentStep - 1].classList.add('active');
                stepCircles[state.currentStep - 1].classList.add('active');
                
                // Mark previous step as completed
                if (state.currentStep > 1) {
                    stepCircles[state.currentStep - 2].classList.add('completed');
                }
                
                log(`Navegaci√≥n al paso ${state.currentStep}.`, 'info');
            }
        }
        
        function previousStep() {
            if (state.currentStep > 1) {
                // Hide current step
                stepContents[state.currentStep - 1].classList.remove('active');
                stepCircles[state.currentStep - 1].classList.remove('active');
                
                // Remove completed mark from current step
                stepCircles[state.currentStep - 1].classList.remove('completed');
                
                // Update current step
                state.currentStep--;
                
                // Show previous step
                stepContents[state.currentStep - 1].classList.add('active');
                stepCircles[state.currentStep - 1].classList.add('active');
                
                log(`Navegaci√≥n al paso ${state.currentStep}.`, 'info');
            }
        }
        
        // Step 1: Folder selection
        async function selectFolder() {
  // Reiniciar el estado
  files = [];
  folderPath.textContent = '';
  fileCount.textContent = '';
  selectedFolder.style.display = 'none';
  filesPreview.style.display = 'none';
  filesList.innerHTML = '';

  try {
    log('Solicitando permiso para acceder a una carpeta...', 'info');
    
    // 1. Llamada clave a la API del navegador
    const directoryHandle = await window.showDirectoryPicker();
    state.folderName = directoryHandle.name;
    log(`Carpeta seleccionada: "${directoryHandle.name}". Leyendo contenido...`, 'info');

    // 2. Leer todos los archivos recursivamente
    await readDirectory(directoryHandle, '');
    log(`Estructura cargada correctamente. ${state.files.length} archivos listos.`, 'success');

    // 3. Actualizar la interfaz de usuario
    folderPath.textContent = state.folderName;
    fileCount.textContent = `${state.files.length} archivos encontrados`;
    selectedFolder.style.display = 'block';
    updateFilePreview(); // Esta funci√≥n debe existir para mostrar la vista previa
    validate(); // Para habilitar el bot√≥n de despliegue

  } catch (error) {
    // Manejo espec√≠fico de errores
    if (error.name === 'AbortError') {
      log('Selecci√≥n de carpeta cancelada por el usuario.', 'info');
    } else {
      log(`Error al acceder a la carpeta: ${error.message}`, 'error');
    }
  }
}
        
        async function readDirectory(directoryHandle, path) {
            for await (const entry of directoryHandle.values()) {
                const entryPath = path + entry.name;
                
                if (entry.kind === 'file') {
                    try {
                        const file = await entry.getFile();
                        const content = await file.text();
                        
                        state.files.push({
                            path: entryPath,
                            content: content,
                            size: file.size,
                            type: file.type
                        });
                    } catch (error) {
                        log(`No se pudo leer el archivo ${entryPath}: ${error.message}`, 'warning');
                    }
                } else if (entry.kind === 'directory') {
                    await readDirectory(entry, entryPath + '/');
                }
            }
        }
        
        function updateFilePreview() {
            if (state.files.length === 0) {
                filesPreview.style.display = 'none';
                return;
            }
            
            // Show only first 10 files for preview
            const previewFiles = state.files.slice(0, 10);
            filesList.innerHTML = '';
            
            previewFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.textContent = `/${file.path}`;
                filesList.appendChild(fileItem);
            });
            
            if (state.files.length > 10) {
                const moreItem = document.createElement('div');
                moreItem.className = 'file-item';
                moreItem.textContent = `... y ${state.files.length - 10} archivos m√°s`;
                filesList.appendChild(moreItem);
            }
            
            filesPreview.style.display = 'block';
        }
        
        // Step 2: GitHub configuration validation
        function validateStep2() {
            state.githubToken = githubTokenInput.value.trim();
            state.repoOwner = repoOwnerInput.value.trim();
            state.repoName = repoNameInput.value.trim();
            
            const isValid = state.githubToken && state.repoOwner && state.repoName;
            nextStep2Button.disabled = !isValid;
            
            // Update status
            const configStatus = document.getElementById('configStatus');
            const statusIcon = configStatus.querySelector('.status-icon');
            const statusText = configStatus.querySelector('.status-text');
            
            if (isValid) {
                statusIcon.className = 'status-icon ready';
                statusIcon.innerHTML = '‚úì';
                statusText.textContent = 'Configuraci√≥n completa. Listo para continuar.';
            } else {
                statusIcon.className = 'status-icon pending';
                statusIcon.innerHTML = '!';
                statusText.textContent = 'Completa todos los campos para continuar.';
            }
            
            return isValid;
        }
        
        // Step 3: Update deployment summary
        function updateDeploymentSummary() {
            summaryFolder.textContent = state.folderName;
            summaryFiles.textContent = `${state.files.length} archivos`;
            summaryRepo.textContent = `${state.repoOwner}/${state.repoName}`;
            
            // Update deploy button state
            deployButton.disabled = state.files.length === 0;
        }
        
        // Step 3: Deployment
        async function deployToGitHub() {
            if (state.files.length === 0) {
                log('Error: No hay archivos para desplegar. Selecciona una carpeta primero.', 'error');
                return;
            }
            
            if (!state.githubToken || !state.repoOwner || !state.repoName) {
                log('Error: Configuraci√≥n de GitHub incompleta.', 'error');
                return;
            }
            
            // Disable deploy button and update status
            deployButton.disabled = true;
            deployButton.textContent = 'Desplegando...';
            
            const deployStatus = document.getElementById('deployStatus');
            const statusIcon = deployStatus.querySelector('.status-icon');
            const statusText = deployStatus.querySelector('.status-text');
            
            statusIcon.className = 'status-icon pending';
            statusIcon.innerHTML = '‚ü≥';
            statusText.textContent = 'Desplegando estructura en GitHub...';
            
            log('Iniciando despliegue en GitHub...', 'info');
            
            try {
                // First, try to get the main branch reference
                let baseTreeSha;
                let parentCommitSha = null;
                
                try {
                    log('Verificando estado del repositorio...', 'info');
                    const refResponse = await githubApiRequest(
                        `repos/${state.repoOwner}/${state.repoName}/git/refs/heads/main`,
                        'GET'
                    );
                    
                    parentCommitSha = refResponse.object.sha;
                    log(`Repositorio encontrado. Commit padre: ${parentCommitSha.substring(0, 8)}`, 'success');
                    
                    // Get the tree of the parent commit
                    const commitResponse = await githubApiRequest(
                        `repos/${state.repoOwner}/${state.repoName}/git/commits/${parentCommitSha}`,
                        'GET'
                    );
                    
                    baseTreeSha = commitResponse.tree.sha;
                    
                } catch (error) {
                    if (error.status === 404) {
                        log('Repositorio vac√≠o detectado. Creando estructura inicial con README...', 'info');
                        
                        // Create initial README.md for empty repository
                        const readmeContent = `# ${state.repoName}\n\nEstructura desplegada autom√°ticamente por PortalHub Creator.\n\n**Fecha:** ${new Date().toLocaleDateString()}\n**Archivos:** ${state.files.length}\n\nEste repositorio contiene una estructura de portal desplegada autom√°ticamente.`;
                        
                        // Create README blob
                        const readmeBlob = await githubApiRequest(
                            `repos/${state.repoOwner}/${state.repoName}/git/blobs`,
                            'POST',
                            {
                                content: btoa(readmeContent),
                                encoding: 'base64'
                            }
                        );
                        
                        log('README.md creado exitosamente.', 'success');
                        
                        // Create initial tree with README
                        const initialTree = await githubApiRequest(
                            `repos/${state.repoOwner}/${state.repoName}/git/trees`,
                            'POST',
                            {
                                tree: [{
                                    path: 'README.md',
                                    mode: '100644',
                                    type: 'blob',
                                    sha: readmeBlob.sha
                                }]
                            }
                        );
                        
                        baseTreeSha = initialTree.sha;
                        
                        // Create initial commit
                        const initialCommit = await githubApiRequest(
                            `repos/${state.repoOwner}/${state.repoName}/git/commits`,
                            'POST',
                            {
                                message: 'Initial commit: Project structure',
                                tree: initialTree.sha,
                                parents: []
                            }
                        );
                        
                        // Create main branch reference
                        await githubApiRequest(
                            `repos/${state.repoOwner}/${state.repoName}/git/refs`,
                            'POST',
                            {
                                ref: 'refs/heads/main',
                                sha: initialCommit.sha
                            }
                        );
                        
                        parentCommitSha = initialCommit.sha;
                        log('Repositorio inicializado con README.md y rama main creada.', 'success');
                        
                    } else {
                        throw error;
                    }
                }
                
                // Create tree with all files from selected folder
                log(`Creando √°rbol con ${state.files.length} archivos...`, 'info');
                
                const treeItems = state.files.map(file => ({
                    path: `portalHub/${file.path}`,
                    mode: '100644',
                    type: 'blob',
                    content: file.content
                }));
                
                // Create new tree
                const newTree = await githubApiRequest(
                    `repos/${state.repoOwner}/${state.repoName}/git/trees`,
                    'POST',
                    {
                        tree: treeItems,
                        base_tree: baseTreeSha
                    }
                );
                
                log(`√Årbol creado exitosamente (SHA: ${newTree.sha.substring(0, 8)}).`, 'success');
                
                // Create new commit
                log('Creando commit...', 'info');
                const newCommit = await githubApiRequest(
                    `repos/${state.repoOwner}/${state.repoName}/git/commits`,
                    'POST',
                    {
                        message: `PortalHub structure: ${state.files.length} files`,
                        tree: newTree.sha,
                        parents: parentCommitSha ? [parentCommitSha] : []
                    }
                );
                
                log(`Commit creado (SHA: ${newCommit.sha.substring(0, 8)}).`, 'success');
                
                // Update main branch reference
                await githubApiRequest(
                    `repos/${state.repoOwner}/${state.repoName}/git/refs/heads/main`,
                    'PATCH',
                    {
                        sha: newCommit.sha,
                        force: false
                    }
                );
                
                log('Rama main actualizada exitosamente.', 'success');
                
                // Update status and UI
                statusIcon.className = 'status-icon ready';
                statusIcon.innerHTML = '‚úì';
                statusText.textContent = `Despliegue completado. ${state.files.length} archivos publicados en portalHub/.`;
                
                deployButton.textContent = 'Desplegar Nuevamente';
                deployButton.disabled = false;
                
                log(`‚úÖ Despliegue completado exitosamente. ${state.files.length} archivos publicados en ${state.repoOwner}/${state.repoName}`, 'success');
                
                // Mark step 3 as completed
                stepCircles[2].classList.add('completed');
                
            } catch (error) {
                log(`‚ùå Error durante el despliegue: ${error.message}`, 'error');
                
                statusIcon.className = 'status-icon error';
                statusIcon.innerHTML = '‚úó';
                statusText.textContent = 'Error durante el despliegue. Revisa el registro.';
                
                deployButton.textContent = 'Reintentar Despliegue';
                deployButton.disabled = false;
            }
        }
        
        // GitHub API helper function
        async function githubApiRequest(endpoint, method = 'GET', body = null) {
            const url = `https://api.github.com/${endpoint}`;
            const headers = {
                'Authorization': `token ${state.githubToken}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            };
            
            const options = {
                method,
                headers
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            const response = await fetch(url, options);
            
            if (!response.ok) {
                const errorText = await response.text();
                let errorMessage;
                
                try {
                    const errorJson = JSON.parse(errorText);
                    errorMessage = errorJson.message || errorText;
                } catch {
                    errorMessage = errorText;
                }
                
                const error = new Error(errorMessage);
                error.status = response.status;
                throw error;
            }
            
            if (response.status === 204) {
                return null;
            }
            
            return await response.json();
        }
        
        // Logging
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const time = document.createElement('span');
            time.className = 'log-time';
            time.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const msg = document.createElement('span');
            msg.className = `log-message ${type}`;
            msg.textContent = message;
            
            entry.appendChild(time);
            entry.appendChild(msg);
            
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }
        
        function clearLog() {
            logBox.innerHTML = '';
            log('Registro limpiado.', 'info');
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
