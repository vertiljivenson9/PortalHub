<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>PortalHub Creator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #475569;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #475569;
            --shadow: rgba(0, 0, 0, 0.25);
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: var(--background);
            color: var(--text-primary);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            padding: 24px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        .app-container {
            width: 100%;
            max-width: 900px;
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 25px var(--shadow);
            overflow: hidden;
        }
        
        .app-header {
            padding: 32px 32px 24px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
        }
        
        .app-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(90deg, var(--primary), #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .app-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 400;
        }
        
        .app-content {
            padding: 32px;
        }
        
        .progress-container {
            display: flex;
            margin-bottom: 40px;
            position: relative;
        }
        
        .progress-line {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 2px;
            background: var(--border);
            z-index: 1;
        }
        
        .progress-step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--surface-light);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            transition: var(--transition);
        }
        
        .step-circle.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .step-circle.completed {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .step-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            text-align: center;
        }
        
        .step-label.active {
            color: var(--text-primary);
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        .section-description {
            color: var(--text-secondary);
            margin-bottom: 24px;
            font-size: 14px;
        }
        
        .folder-selector {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 40px 24px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(30, 41, 59, 0.5);
        }
        
        .folder-selector:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }
        
        .folder-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--primary);
        }
        
        .folder-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .folder-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .folder-button {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 500;
            transition: var(--transition);
            border: none;
            cursor: pointer;
        }
        
        .folder-button:hover {
            background: var(--primary-dark);
        }
        
        .selected-folder {
            margin-top: 20px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary);
        }
        
        .folder-path {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            color: var(--text-primary);
            word-break: break-all;
        }
        
        .file-count {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 15px;
            transition: var(--transition);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--text-secondary);
        }
        
        .form-hint {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 6px;
        }
        
        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }
        
        .button {
            padding: 14px 28px;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-family: inherit;
        }
        
        .button-primary {
            background: var(--primary);
            color: white;
            flex: 1;
        }
        
        .button-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }
        
        .button-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .button-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .log-container {
            margin-top: 32px;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .log-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .clear-log {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .clear-log:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .log-box {
            height: 300px;
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.7);
            border-radius: var(--radius-md);
            padding: 20px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            border: 1px solid var(--border);
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }
        
        .log-entry:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        .log-time {
            color: var(--text-secondary);
            font-size: 12px;
            margin-right: 10px;
        }
        
        .log-message {
            color: var(--text-primary);
        }
        
        .log-message.success {
            color: var(--success);
        }
        
        .log-message.error {
            color: var(--error);
        }
        
        .log-message.warning {
            color: var(--warning);
        }
        
        .log-message.info {
            color: var(--primary);
        }
        
        .status-summary {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            border-left: 4px solid var(--primary);
        }
        
        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .status-icon.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .status-icon.ready {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .status-text {
            font-size: 14px;
        }
        
        .files-preview {
            margin-top: 24px;
        }
        
        .files-list {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.5);
            border-radius: var(--radius-md);
            padding: 16px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
        }
        
        .file-item {
            padding: 6px 0;
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 16px;
            }
            
            .app-header, .app-content {
                padding: 24px 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .progress-step {
                min-width: 80px;
            }
            
            .step-label {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1 class="app-title">PortalHub Creator</h1>
            <p class="app-subtitle">Despliega estructuras de carpetas en repositorios GitHub</p>
        </header>
        
        <div class="app-content">
            <!-- Progress Steps -->
            <div class="progress-container">
                <div class="progress-line"></div>
                
                <div class="progress-step">
                    <div class="step-circle active" id="step1-circle">1</div>
                    <div class="step-label active">Seleccionar Carpeta</div>
                </div>
                
                <div class="progress-step">
                    <div class="step-circle" id="step2-circle">2</div>
                    <div class="step-label">Configurar GitHub</div>
                </div>
                
                <div class="progress-step">
                    <div class="step-circle" id="step3-circle">3</div>
                    <div class="step-label">Desplegar</div>
                </div>
            </div>
            
            <!-- Step 1: Folder Selection -->
            <div class="step-content active" id="step1-content">
                <h2 class="section-title">Seleccionar Carpeta Local</h2>
                <p class="section-description">Selecciona la carpeta que contiene la estructura que deseas desplegar en GitHub.</p>
                
                <div class="folder-selector" id="folderSelector">
                    <div class="folder-icon">üìÅ</div>
                    <h3 class="folder-title">Seleccionar Carpeta</h3>
                    <p class="folder-subtitle">Haz clic para explorar y seleccionar una carpeta de tu dispositivo</p>
                    <div class="folder-button">Examinar Carpeta</div>
                </div>
                
                <div class="selected-folder" id="selectedFolder" style="display: none;">
                    <div class="folder-path" id="folderPath"></div>
                    <div class="file-count" id="fileCount"></div>
                </div>
                
                <div class="files-preview" id="filesPreview" style="display: none;">
                    <h3 class="section-title">Vista Previa de Archivos</h3>
                    <div class="files-list" id="filesList"></div>
                </div>
                
                <div class="action-buttons">
                    <button class="button button-secondary" onclick="previousStep()" style="visibility: hidden;">Anterior</button>
                    <button class="button button-primary" onclick="nextStep()" id="nextStep1">Siguiente: Configuraci√≥n GitHub</button>
                </div>
            </div>
            
            <!-- Step 2: GitHub Configuration -->
            <div class="step-content" id="step2-content">
                <h2 class="section-title">Configuraci√≥n de GitHub</h2>
                <p class="section-description">Proporciona tus credenciales de GitHub y los detalles del repositorio.</p>
                
                <div class="form-group">
                    <label class="form-label" for="githubToken">Token de Acceso Personal de GitHub</label>
                    <input type="password" class="form-input" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                    <p class="form-hint">Necesitas un token con permisos "repo" para acceder a repositorios. <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--primary); text-decoration: none;">Generar token</a></p>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="repoOwner">Propietario del Repositorio</label>
                    <input type="text" class="form-input" id="repoOwner" placeholder="nombre-usuario-o-organizacion" />
                    <p class="form-hint">Tu nombre de usuario de GitHub o el nombre de la organizaci√≥n.</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="repoName">Nombre del Repositorio</label>
                    <input type="text" class="form-input" id="repoName" placeholder="nombre-repositorio" />
                    <p class="form-hint">Nombre del repositorio donde se desplegar√° la estructura.</p>
                </div>
                
                <div class="status-summary" id="configStatus">
                    <div class="status-icon pending">
                        <span>!</span>
                    </div>
                    <div class="status-text">Completa todos los campos para continuar.</div>
                </div>
                
                <div class="action-buttons">
                    <button class="button button-secondary" onclick="previousStep()">Anterior</button>
                    <button class="button button-primary" onclick="nextStep()" id="nextStep2" disabled>Siguiente: Revisar y Desplegar</button>
                </div>
            </div>
            
            <!-- Step 3: Deploy -->
            <div class="step-content" id="step3-content">
                <h2 class="section-title">Revisar y Desplegar</h2>
                <p class="section-description">Revisa la configuraci√≥n y despliega la estructura en GitHub.</p>
                
                <div class="status-summary" id="deployStatus">
                    <div class="status-icon pending">
                        <span>!</span>
                    </div>
                    <div class="status-text">Listo para desplegar. Revisa la configuraci√≥n a continuaci√≥n.</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Resumen de la Configuraci√≥n</label>
                    <div style="background: rgba(15, 23, 42, 0.7); border-radius: var(--radius-md); padding: 20px;">
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 13px; color: var(--text-secondary);">Carpeta seleccionada:</div>
                            <div id="summaryFolder" style="font-family: 'Monaco', 'Consolas', monospace; font-size: 14px; margin-top: 4px;">-</div>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 13px; color: var(--text-secondary);">Archivos a desplegar:</div>
                            <div id="summaryFiles" style="font-family: 'Monaco', 'Consolas', monospace; font-size: 14px; margin-top: 4px;">0</div>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 13px; color: var(--text-secondary);">Repositorio de destino:</div>
                            <div id="summaryRepo" style="font-family: 'Monaco', 'Consolas', monospace; font-size: 14px; margin-top: 4px;">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="button button-secondary" onclick="previousStep()">Anterior</button>
                    <button class="button button-primary" onclick="deployToGitHub()" id="deployButton">Iniciar Despliegue</button>
                </div>
                
                <div class="log-container">
                    <div class="log-header">
                        <h3 class="log-title">Registro de Actividad</h3>
                        <button class="clear-log" onclick="clearLog()">Limpiar Registro</button>
                    </div>
                    <div class="log-box" id="logBox"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management - SIMPLIFICADO Y CORREGIDO
        const state = {
            currentStep: 1,
            files: [],
            folderName: '',
            githubToken: '',
            repoOwner: '',
            repoName: ''
        };

        // DOM Elements
        const stepCircles = [
            document.getElementById('step1-circle'),
            document.getElementById('step2-circle'),
            document.getElementById('step3-circle')
        ];
        
        const stepContents = [
            document.getElementById('step1-content'),
            document.getElementById('step2-content'),
            document.getElementById('step3-content')
        ];
        
        // Inicializaci√≥n CORREGIDA - Event listeners SIMPLIFICADOS
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar el selector de carpeta - M√âTODO CORREGIDO
            const folderSelector = document.getElementById('folderSelector');
            folderSelector.addEventListener('click', selectFolder);
            
            // Configurar validaci√≥n de GitHub
            document.getElementById('githubToken').addEventListener('input', validateStep2);
            document.getElementById('repoOwner').addEventListener('input', validateStep2);
            document.getElementById('repoName').addEventListener('input', validateStep2);
            
            // Log inicial
            log('PortalHub Creator iniciado correctamente.', 'info');
        });

        // FUNCI√ìN SELECTFOLDER COMPLETAMENTE CORREGIDA - NO M√ÅS CONGELAMIENTOS
        async function selectFolder() {
            try {
                // Limpiar estado anterior
                state.files = [];
                document.getElementById('folderPath').textContent = '';
                document.getElementById('fileCount').textContent = '';
                document.getElementById('selectedFolder').style.display = 'none';
                document.getElementById('filesPreview').style.display = 'none';
                document.getElementById('filesList').innerHTML = '';
                
                log('Abriendo selector de carpeta del sistema...', 'info');
                
                // USAR showDirectoryPicker CORRECTAMENTE - con prefijo opcional
                const dirHandle = window.showDirectoryPicker ? 
                    await window.showDirectoryPicker() : 
                    (() => { throw new Error('API no disponible en este navegador'); })();
                
                if (!dirHandle) {
                    log('Selecci√≥n cancelada por el usuario.', 'info');
                    return;
                }
                
                state.folderName = dirHandle.name;
                log(`Carpeta seleccionada: "${state.folderName}". Leyendo archivos...`, 'info');
                
                // Funci√≥n optimizada para leer archivos
                async function readAllFiles(directoryHandle, path = '') {
                    const files = [];
                    
                    try {
                        for await (const entry of directoryHandle.values()) {
                            const entryPath = path + entry.name;
                            
                            if (entry.kind === 'file') {
                                try {
                                    const file = await entry.getFile();
                                    const content = await file.text();
                                    
                                    files.push({
                                        path: entryPath,
                                        content: content,
                                        size: file.size
                                    });
                                    
                                    // Actualizar progreso cada 10 archivos
                                    if (files.length % 10 === 0) {
                                        log(`${files.length} archivos le√≠dos...`, 'info');
                                    }
                                } catch (err) {
                                    log(`No se pudo leer ${entryPath}: ${err.message}`, 'warning');
                                }
                            } else if (entry.kind === 'directory') {
                                const subFiles = await readAllFiles(entry, entryPath + '/');
                                files.push(...subFiles);
                            }
                        }
                    } catch (err) {
                        log(`Error leyendo directorio: ${err.message}`, 'error');
                    }
                    
                    return files;
                }
                
                // Leer archivos con timeout para evitar bloqueos
                const readPromise = readAllFiles(dirHandle, '');
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout leyendo archivos')), 30000)
                );
                
                state.files = await Promise.race([readPromise, timeoutPromise]);
                
                log(`Lectura completada: ${state.files.length} archivos encontrados.`, 'success');
                
                // Actualizar UI
                document.getElementById('folderPath').textContent = state.folderName;
                document.getElementById('fileCount').textContent = `${state.files.length} archivos listos`;
                document.getElementById('selectedFolder').style.display = 'block';
                
                // Mostrar vista previa
                updateFilePreview();
                
                // Habilitar siguiente paso
                document.getElementById('nextStep1').disabled = false;
                
            } catch (error) {
                if (error.name === 'AbortError' || error.message.includes('cancelada')) {
                    log('Selecci√≥n de carpeta cancelada.', 'info');
                } else if (error.message.includes('Timeout')) {
                    log('La lectura de archivos tom√≥ demasiado tiempo. Intenta con menos archivos.', 'error');
                } else if (error.message.includes('API no disponible')) {
                    log('Error: Tu navegador no soporta la selecci√≥n de carpetas. Usa Chrome o Edge.', 'error');
                } else {
                    log(`Error: ${error.message}`, 'error');
                }
            }
        }
        
        // Funci√≥n auxiliar para vista previa
        function updateFilePreview() {
            const filesList = document.getElementById('filesList');
            const filesPreview = document.getElementById('filesPreview');
            
            if (state.files.length === 0) {
                filesPreview.style.display = 'none';
                return;
            }
            
            // Mostrar primeros 15 archivos
            const previewFiles = state.files.slice(0, 15);
            filesList.innerHTML = '';
            
            previewFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.textContent = `/${file.path}`;
                filesList.appendChild(fileItem);
            });
            
            if (state.files.length > 15) {
                const moreItem = document.createElement('div');
                moreItem.className = 'file-item';
                moreItem.textContent = `... y ${state.files.length - 15} archivos m√°s`;
                filesList.appendChild(moreItem);
            }
            
            filesPreview.style.display = 'block';
        }
        
        // Navegaci√≥n entre pasos
        function nextStep() {
            if (state.currentStep < 3) {
                // Validar antes de avanzar
                if (state.currentStep === 1 && state.files.length === 0) {
                    log('Selecciona una carpeta primero.', 'warning');
                    return;
                }
                
                if (state.currentStep === 2) {
                    // Actualizar estado desde inputs
                    state.githubToken = document.getElementById('githubToken').value.trim();
                    state.repoOwner = document.getElementById('repoOwner').value.trim();
                    state.repoName = document.getElementById('repoName').value.trim();
                    
                    if (!state.githubToken || !state.repoOwner || !state.repoName) {
                        log('Completa todos los campos de GitHub.', 'warning');
                        return;
                    }
                    
                    // Actualizar resumen
                    updateDeploymentSummary();
                }
                
                // Cambiar paso
                stepContents[state.currentStep - 1].classList.remove('active');
                stepCircles[state.currentStep - 1].classList.remove('active');
                
                state.currentStep++;
                
                stepContents[state.currentStep - 1].classList.add('active');
                stepCircles[state.currentStep - 1].classList.add('active');
                
                if (state.currentStep > 1) {
                    stepCircles[state.currentStep - 2].classList.add('completed');
                }
                
                log(`Paso ${state.currentStep} activado.`, 'info');
            }
        }
        
        function previousStep() {
            if (state.currentStep > 1) {
                stepContents[state.currentStep - 1].classList.remove('active');
                stepCircles[state.currentStep - 1].classList.remove('active');
                stepCircles[state.currentStep - 1].classList.remove('completed');
                
                state.currentStep--;
                
                stepContents[state.currentStep - 1].classList.add('active');
                stepCircles[state.currentStep - 1].classList.add('active');
                
                log(`Volviendo al paso ${state.currentStep}.`, 'info');
            }
        }
        
        // Validaci√≥n paso 2
        function validateStep2() {
            const token = document.getElementById('githubToken').value.trim();
            const owner = document.getElementById('repoOwner').value.trim();
            const repo = document.getElementById('repoName').value.trim();
            
            const isValid = token && owner && repo;
            document.getElementById('nextStep2').disabled = !isValid;
            
            const configStatus = document.getElementById('configStatus');
            const statusIcon = configStatus.querySelector('.status-icon');
            const statusText = configStatus.querySelector('.status-text');
            
            if (isValid) {
                statusIcon.className = 'status-icon ready';
                statusIcon.innerHTML = '‚úì';
                statusText.textContent = 'Configuraci√≥n completa.';
            } else {
                statusIcon.className = 'status-icon pending';
                statusIcon.innerHTML = '!';
                statusText.textContent = 'Completa todos los campos.';
            }
            
            return isValid;
        }
        
        // Actualizar resumen
        function updateDeploymentSummary() {
            document.getElementById('summaryFolder').textContent = state.folderName;
            document.getElementById('summaryFiles').textContent = `${state.files.length} archivos`;
            document.getElementById('summaryRepo').textContent = `${state.repoOwner}/${state.repoName}`;
            
            document.getElementById('deployButton').disabled = state.files.length === 0;
        }
        
        // DESPLIEGUE A GITHUB - CORREGIDO
        async function deployToGitHub() {
            if (state.files.length === 0) {
                log('Error: No hay archivos para desplegar.', 'error');
                return;
            }
            
            const deployButton = document.getElementById('deployButton');
            const originalText = deployButton.textContent;
            deployButton.disabled = true;
            deployButton.textContent = 'Desplegando...';
            
            const deployStatus = document.getElementById('deployStatus');
            const statusIcon = deployStatus.querySelector('.status-icon');
            const statusText = deployStatus.querySelector('.status-text');
            
            statusIcon.className = 'status-icon pending';
            statusIcon.innerHTML = '‚ü≥';
            statusText.textContent = 'Conectando con GitHub...';
            
            log('Iniciando despliegue...', 'info');
            
            try {
                // 1. Verificar o crear repositorio
                log('Verificando estado del repositorio...', 'info');
                
                let parentCommitSha = null;
                let baseTreeSha = null;
                
                try {
                    // Intentar obtener referencia main
                    const refData = await githubRequest(`repos/${state.repoOwner}/${state.repoName}/git/refs/heads/main`, 'GET');
                    parentCommitSha = refData.object.sha;
                    
                    // Obtener commit para el √°rbol base
                    const commitData = await githubRequest(`repos/${state.repoOwner}/${state.repoName}/git/commits/${parentCommitSha}`, 'GET');
                    baseTreeSha = commitData.tree.sha;
                    
                    log(`Repositorio existente. Commit actual: ${parentCommitSha.substring(0, 8)}`, 'success');
                    
                } catch (error) {
                    if (error.status === 404) {
                        log('Repositorio vac√≠o. Creando estructura inicial...', 'info');
                        
                        // Crear README inicial
                        const readmeContent = `# ${state.repoName}\n\nEstructura desplegada autom√°ticamente por PortalHub Creator.\n\n**Fecha:** ${new Date().toLocaleDateString()}\n**Total archivos:** ${state.files.length}\n\n---\n\nEste repositorio contiene una estructura generada autom√°ticamente.`;
                        
                        const readmeBlob = await githubRequest(
                            `repos/${state.repoOwner}/${state.repoName}/git/blobs`,
                            'POST',
                            { content: btoa(readmeContent), encoding: 'base64' }
                        );
                        
                        // Crear √°rbol inicial
                        const initialTree = await githubRequest(
                            `repos/${state.repoOwner}/${state.repoName}/git/trees`,
                            'POST',
                            {
                                tree: [{
                                    path: 'README.md',
                                    mode: '100644',
                                    type: 'blob',
                                    sha: readmeBlob.sha
                                }]
                            }
                        );
                        
                        // Crear commit inicial
                        const initialCommit = await githubRequest(
                            `repos/${state.repoOwner}/${state.repoName}/git/commits`,
                            'POST',
                            {
                                message: 'Initial commit: PortalHub structure',
                                tree: initialTree.sha,
                                parents: []
                            }
                        );
                        
                        // Crear rama main
                        await githubRequest(
                            `repos/${state.repoOwner}/${state.repoName}/git/refs`,
                            'POST',
                            {
                                ref: 'refs/heads/main',
                                sha: initialCommit.sha
                            }
                        );
                        
                        parentCommitSha = initialCommit.sha;
                        baseTreeSha = initialTree.sha;
                        
                        log('Repositorio inicializado con README.md', 'success');
                    } else {
                        throw error;
                    }
                }
                
                // 2. Crear √°rbol con archivos
                log(`Creando √°rbol con ${state.files.length} archivos...`, 'info');
                
                const treeItems = state.files.map(file => ({
                    path: `portalHub/${file.path}`,
                    mode: '100644',
                    type: 'blob',
                    content: file.content
                }));
                
                const newTree = await githubRequest(
                    `repos/${state.repoOwner}/${state.repoName}/git/trees`,
                    'POST',
                    {
                        tree: treeItems,
                        base_tree: baseTreeSha
                    }
                );
                
                log(`√Årbol creado: ${newTree.sha.substring(0, 8)}`, 'success');
                
                // 3. Crear commit
                log('Creando commit...', 'info');
                const newCommit = await githubRequest(
                    `repos/${state.repoOwner}/${state.repoName}/git/commits`,
                    'POST',
                    {
                        message: `Deploy PortalHub: ${state.files.length} files - ${new Date().toLocaleDateString()}`,
                        tree: newTree.sha,
                        parents: parentCommitSha ? [parentCommitSha] : []
                    }
                );
                
                // 4. Actualizar referencia main
                await githubRequest(
                    `repos/${state.repoOwner}/${state.repoName}/git/refs/heads/main`,
                    'PATCH',
                    {
                        sha: newCommit.sha,
                        force: false
                    }
                );
                
                // √âXITO
                statusIcon.className = 'status-icon ready';
                statusIcon.innerHTML = '‚úì';
                statusText.textContent = `Despliegue completado. ${state.files.length} archivos publicados.`;
                
                stepCircles[2].classList.add('completed');
                
                log(`‚úÖ DESPLIEGUE EXITOSO: ${state.files.length} archivos publicados en ${state.repoOwner}/${state.repoName}/portalHub/`, 'success');
                
            } catch (error) {
                statusIcon.className = 'status-icon error';
                statusIcon.innerHTML = '‚úó';
                statusText.textContent = 'Error en el despliegue.';
                
                log(`‚ùå ERROR: ${error.message || 'Error desconocido'}`, 'error');
                
                if (error.status === 401) {
                    log('Token de GitHub inv√°lido o expirado.', 'error');
                } else if (error.status === 403) {
                    log('Permisos insuficientes. Verifica que el token tenga acceso "repo".', 'error');
                } else if (error.status === 404) {
                    log('Repositorio no encontrado. Verifica owner y nombre.', 'error');
                }
            } finally {
                deployButton.disabled = false;
                deployButton.textContent = originalText;
            }
        }
        
        // Helper para requests GitHub - SIMPLIFICADO
        async function githubRequest(endpoint, method = 'GET', body = null) {
            const url = `https://api.github.com/${endpoint}`;
            const options = {
                method,
                headers: {
                    'Authorization': `token ${state.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                }
            };
            
            if (body) options.body = JSON.stringify(body);
            
            const response = await fetch(url, options);
            
            if (!response.ok) {
                let errorMsg = `HTTP ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.message || errorMsg;
                } catch {}
                
                const error = new Error(errorMsg);
                error.status = response.status;
                throw error;
            }
            
            if (response.status === 204) return null;
            return await response.json();
        }
        
        // Logging
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const time = new Date().toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            entry.innerHTML = `<span class="log-time">[${time}]</span>
                               <span class="log-message ${type}">${message}</span>`;
            
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logBox').innerHTML = '';
            log('Registro limpiado.', 'info');
        }
    </script>
</body>
</html>
