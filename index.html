<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<title>PortalHub Creator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
:root {
  --bg: #0b0e14;
  --panel: #111827;
  --accent: #6366f1;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --success: #22c55e;
  --error: #ef4444;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
  display: flex;
  justify-content: center;
  padding: 30px;
}

.app {
  width: 100%;
  max-width: 820px;
  background: var(--panel);
  border-radius: 14px;
  padding: 24px;
  box-shadow: 0 0 40px rgba(0,0,0,.6);
}

/* Header */
.header {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 20px;
}

.logo {
  width: 42px;
  height: 42px;
}

h1 {
  font-size: 20px;
  margin: 0;
}

.subtitle {
  font-size: 12px;
  color: var(--muted);
}

/* Inputs */
input, button {
  width: 100%;
  margin-top: 10px;
  padding: 12px;
  border-radius: 8px;
  border: none;
  font-family: inherit;
}

input {
  background: #020617;
  color: var(--text);
  border: 1px solid #1f2937;
}

button {
  background: var(--accent);
  color: white;
  font-weight: 600;
  cursor: pointer;
}

button.secondary {
  background: #020617;
  border: 1px dashed #374151;
  color: var(--text);
}

button:disabled {
  opacity: .5;
  cursor: not-allowed;
}

/* Log */
.log {
  margin-top: 18px;
  background: #020617;
  border-radius: 10px;
  padding: 14px;
  height: 260px;
  overflow-y: auto;
  font-size: 12px;
  border: 1px solid #1f2937;
}

.log div {
  margin-bottom: 4px;
}

.ok { color: var(--success); }
.err { color: var(--error); }
.muted { color: var(--muted); }
</style>
</head>

<body>

<div class="app">

  <div class="header">
    <svg class="logo" viewBox="0 0 100 100">
      <polygon points="50,5 95,27 95,73 50,95 5,73 5,27"
               fill="#6366f1"/>
      <circle cx="50" cy="50" r="18" fill="#0b0e14"/>
    </svg>
    <div>
      <h1>PortalHub Creator</h1>
      <div class="subtitle">Local folder → GitHub structure</div>
    </div>
  </div>

  <input id="token" type="password" placeholder="GitHub Personal Access Token (ghp_…)" />
  <input id="owner" placeholder="Repository owner" />
  <input id="repo" placeholder="Repository name" />

  <button class="secondary" onclick="selectFolder()">Selecionar pasta local</button>
  <button id="deployBtn" onclick="deploy()" disabled>Criar estrutura portalHub</button>

  <div class="log" id="log"></div>

</div>

<script>
let files = [];
const logBox = document.getElementById("log");
const deployBtn = document.getElementById("deployBtn");

function log(msg, cls="") {
  const d = document.createElement("div");
  d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  if (cls) d.className = cls;
  logBox.appendChild(d);
  logBox.scrollTop = logBox.scrollHeight;
}

/* =======================
   FILE SYSTEM
======================= */
async function selectFolder() {
  files = [];
  try {
    const handle = await window.showDirectoryPicker();
    log("Pasta local carregada (nome ignorado)", "muted");
    await readDir(handle, "");
    log(`Arquivos detectados: ${files.length}`, "ok");
    deployBtn.disabled = files.length === 0;
  } catch {
    log("Seleção cancelada ou não suportada", "err");
  }
}

async function readDir(dir, base) {
  for await (const entry of dir.values()) {
    if (entry.kind === "file") {
      const f = await entry.getFile();
      files.push({
        path: base + entry.name,
        content: await f.text()
      });
    } else {
      await readDir(entry, base + entry.name + "/");
    }
  }
}

/* =======================
   GITHUB
======================= */
async function gh(url, method, token, body) {
  const r = await fetch(url, {
    method,
    headers: {
      Authorization: `token ${token}`,
      Accept: "application/vnd.github.v3+json",
      "Content-Type": "application/json"
    },
    body: body ? JSON.stringify(body) : null
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

async function deploy() {
  const token = tokenInput.value.trim();
  const owner = ownerInput.value.trim();
  const repo  = repoInput.value.trim();

  if (!token.startsWith("ghp_")) {
    alert("Token inválido");
    return;
  }

  deployBtn.disabled = true;
  log("Iniciando replicação portalHub…");

  try {
    const ref = await gh(
      `https://api.github.com/repos/${owner}/${repo}/git/refs/heads/main`,
      "GET", token
    );

    const tree = files.map(f => ({
      path: `portalHub/${f.path}`,
      mode: "100644",
      type: "blob",
      content: f.content
    }));

    const treeRes = await gh(
      `https://api.github.com/repos/${owner}/${repo}/git/trees`,
      "POST", token, { tree }
    );

    const commit = await gh(
      `https://api.github.com/repos/${owner}/${repo}/git/commits`,
      "POST", token, {
        message: `PortalHub structure`,
        tree: treeRes.sha,
        parents: [ref.object.sha]
      }
    );

    await gh(
      `https://api.github.com/repos/${owner}/${repo}/git/refs/heads/main`,
      "PATCH", token, { sha: commit.sha, force: true }
    );

    log("PortalHub criado com sucesso", "ok");
  } catch (e) {
    log("Erro: " + e.message, "err");
    deployBtn.disabled = false;
  }
}
</script>

</body>
</html>
