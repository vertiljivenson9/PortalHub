<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>PortalHub Creator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
body {
  margin: 0;
  background: #0b0e14;
  color: #e5e7eb;
  font-family: ui-monospace, monospace;
  display: flex;
  justify-content: center;
  padding: 30px;
}
.app {
  max-width: 760px;
  width: 100%;
  background: #111827;
  border-radius: 12px;
  padding: 24px;
}
h1 { margin: 0 0 6px; }
small { color: #9ca3af; }

input, button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  background: #020617;
  border: 1px solid #1f2937;
  color: #fff;
  border-radius: 8px;
}
button {
  background: #6366f1;
  font-weight: 600;
  cursor: pointer;
}
button.secondary {
  background: #020617;
  border-style: dashed;
}
button:disabled {
  opacity: .5;
  cursor: not-allowed;
}

.log {
  margin-top: 16px;
  height: 240px;
  overflow-y: auto;
  background: #020617;
  padding: 12px;
  border-radius: 8px;
  font-size: 12px;
}
.selected-folder {
  margin-top: 10px;
  padding: 8px;
  background: #1e293b;
  border-radius: 6px;
  font-size: 11px;
  border-left: 3px solid #6366f1;
}
.file-count {
  color: #9ca3af;
  font-size: 11px;
  margin-top: 4px;
}
</style>
</head>

<body>
<div class="app">

<h1>PortalHub Creator</h1>
<small>Selecciona carpeta ‚Üí configura GitHub ‚Üí publica</small>

<!-- PASO 1: carpeta -->
<button class="secondary" onclick="selectFolder()">üìÇ Seleccionar carpeta local</button>
<div id="selectedFolder" class="selected-folder" style="display: none;">
  <div id="folderPath"></div>
  <div id="fileCount" class="file-count"></div>
</div>

<!-- PASO 2: credenciales -->
<input id="token" type="password" placeholder="GitHub Token (ghp_‚Ä¶)" />
<input id="owner" placeholder="Repository owner (ej: vertiljivenson9)" />
<input id="repo" placeholder="Repository name (ej: Prueba)" />

<!-- PASO 3: deploy -->
<button id="deployBtn" onclick="deploy()" disabled>üöÄ Publicar en GitHub</button>

<div class="log" id="log"></div>

<!-- Input oculto para selecci√≥n de carpeta -->
<input type="file" id="folderInput" webkitdirectory multiple style="display: none;" />

</div>

<script>
let files = [];
let folderName = '';
const logBox = document.getElementById("log");
const deployBtn = document.getElementById("deployBtn");
const tokenInput = document.getElementById("token");
const ownerInput = document.getElementById("owner");
const repoInput = document.getElementById("repo");
const folderInput = document.getElementById("folderInput");

function log(msg) {
  const d = document.createElement("div");
  d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  logBox.appendChild(d);
  logBox.scrollTop = logBox.scrollHeight;
}

/* ========= PASO 1: CARPETA ========= */
async function selectFolder() {
  folderInput.click();
}

// Manejar selecci√≥n de carpeta
folderInput.addEventListener('change', async function(e) {
  files = [];
  const fileList = e.target.files;
  
  if (!fileList || fileList.length === 0) {
    log("Selecci√≥n cancelada");
    return;
  }
  
  // Obtener nombre de carpeta
  const firstFile = fileList[0];
  folderName = firstFile.webkitRelativePath.split('/')[0];
  
  log(`Carpeta seleccionada: "${folderName}"`);
  log(`Leyendo ${fileList.length} archivos...`);
  
  // Mostrar informaci√≥n de carpeta
  document.getElementById('selectedFolder').style.display = 'block';
  document.getElementById('folderPath').textContent = folderName;
  document.getElementById('fileCount').textContent = `${fileList.length} archivos detectados`;
  
  // Leer archivos
  for (let i = 0; i < fileList.length; i++) {
    const file = fileList[i];
    const relativePath = file.webkitRelativePath;
    
    // Remover nombre de carpeta del path
    const pathWithoutFolder = relativePath.substring(folderName.length + 1);
    
    try {
      const content = await readFileAsText(file);
      files.push({
        path: pathWithoutFolder,
        content: content
      });
    } catch (error) {
      log(`Error leyendo ${pathWithoutFolder}: ${error.message}`);
    }
  }
  
  log(`Estructura cargada (${files.length} archivos)`);
  validate();
  
  // Limpiar input
  folderInput.value = '';
});

function readFileAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.onerror = (e) => reject(new Error('No se pudo leer el archivo'));
    reader.readAsText(file);
  });
}

/* ========= VALIDACI√ìN ========= */
function validate() {
  const token = tokenInput.value.trim();
  const owner = ownerInput.value.trim();
  const repo  = repoInput.value.trim();
  deployBtn.disabled = !(files.length && token && owner && repo);
}

tokenInput.oninput = validate;
ownerInput.oninput = validate;
repoInput.oninput = validate;

/* ========= PASO 3: GITHUB ========= */
async function gh(url, method, token, body) {
  const response = await fetch(url, {
    method,
    headers: {
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    },
    body: body ? JSON.stringify(body) : null
  });
  
  if (!response.ok) {
    let errorMsg = `Error ${response.status}`;
    try {
      const errorData = await response.json();
      errorMsg = errorData.message || errorMsg;
    } catch {}
    throw new Error(errorMsg);
  }
  
  return await response.json();
}

async function deploy() {
  const token = tokenInput.value.trim();
  const owner = ownerInput.value.trim();
  const repo  = repoInput.value.trim();

  deployBtn.disabled = true;
  log("Publicando estructura portalHub‚Ä¶");

  try {
    // 1. Verificar si existe la rama main
    let ref;
    try {
      ref = await gh(
        `https://api.github.com/repos/${owner}/${repo}/git/refs/heads/main`,
        "GET", token
      );
      log(`‚úÖ Rama main encontrada: ${ref.object.sha.substring(0, 8)}`);
    } catch (error) {
      if (error.message.includes('404') || error.message.includes('Not Found')) {
        log("‚ö†Ô∏è Repositorio vac√≠o. Creando README inicial...");
        
        // Crear README.md inicial
        const readmeContent = `# ${repo}\n\nRepositorio creado autom√°ticamente por PortalHub Creator\n\n**Fecha**: ${new Date().toLocaleDateString()}\n**Archivos a subir**: ${files.length}\n\n---\n\nEsta carpeta ser√° poblada con la estructura PortalHub.`;
        
        // Crear blob del README
        const readmeBlob = await gh(
          `https://api.github.com/repos/${owner}/${repo}/git/blobs`,
          "POST", token, {
            content: btoa(readmeContent),
            encoding: "base64"
          }
        );
        
        // Crear √°rbol inicial con README
        const initialTree = await gh(
          `https://api.github.com/repos/${owner}/${repo}/git/trees`,
          "POST", token, {
            tree: [{
              path: "README.md",
              mode: "100644",
              type: "blob",
              sha: readmeBlob.sha
            }]
          }
        );
        
        // Crear commit inicial
        const initialCommit = await gh(
          `https://api.github.com/repos/${owner}/${repo}/git/commits`,
          "POST", token, {
            message: "Initial commit: PortalHub structure",
            tree: initialTree.sha,
            parents: []
          }
        );
        
        // Crear rama main
        ref = await gh(
          `https://api.github.com/repos/${owner}/${repo}/git/refs`,
          "POST", token, {
            ref: "refs/heads/main",
            sha: initialCommit.sha
          }
        );
        
        log("‚úÖ README.md creado y rama main inicializada");
      } else {
        throw error;
      }
    }

    // 2. Crear √°rbol con los archivos
    const treeItems = files.map(f => ({
      path: `portalHub/${f.path}`,
      mode: "100644",
      type: "blob",
      content: f.content
    }));

    const tree = await gh(
      `https://api.github.com/repos/${owner}/${repo}/git/trees`,
      "POST", token, { tree: treeItems }
    );

    // 3. Crear commit
    const commit = await gh(
      `https://api.github.com/repos/${owner}/${repo}/git/commits`,
      "POST", token, {
        message: `PortalHub: ${files.length} archivos\n\nCarpeta: ${folderName}\nFecha: ${new Date().toLocaleString()}`,
        tree: tree.sha,
        parents: ref ? [ref.object.sha] : []
      }
    );

    // 4. Actualizar rama main
    await gh(
      `https://api.github.com/repos/${owner}/${repo}/git/refs/heads/main`,
      "PATCH", token, { 
        sha: commit.sha, 
        force: false 
      }
    );

    log("‚úÖ ‚úÖ Publicaci√≥n completada exitosamente!");
    log(`üìÅ Archivos disponibles en: https://github.com/${owner}/${repo}/tree/main/portalHub`);
    log(`üîó Repositorio: https://github.com/${owner}/${repo}`);
    
  } catch (e) {
    log("‚ùå Error: " + e.message);
    
    // Mensajes espec√≠ficos para errores comunes
    if (e.message.includes('Bad credentials')) {
      log("‚ö†Ô∏è Token inv√°lido o expirado. Genera uno nuevo en GitHub Settings > Tokens");
    } else if (e.message.includes('Not Found')) {
      log("‚ö†Ô∏è Repositorio no encontrado. Verifica usuario y nombre del repo");
    } else if (e.message.includes('rate limit')) {
      log("‚ö†Ô∏è L√≠mite de API alcanzado. Espera 1 hora o usa autenticaci√≥n");
    }
    
    deployBtn.disabled = false;
  }
}
</script>
</body>
</html>
