<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PortalHub Creator - Universal</title>
    <style>
        :root {
            --primary: #238636;
            --primary-dark: #196c2e;
            --secondary: #1f6feb;
            --danger: #f85149;
            --warning: #d29922;
            --success: #238636;
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-input: #010409;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --border: #30363d;
            --radius: 6px;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header */
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(16, 25, 40, 0.8);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }
        
        .app-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }
        
        @media (min-width: 768px) {
            .app-layout { grid-template-columns: 1fr 1fr; }
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 1.3rem;
        }
        
        .card-title i { color: var(--primary); }
        
        /* Formularios */
        .form-group { margin-bottom: 20px; }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(35, 134, 54, 0.3);
        }
        
        /* Botones */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-secondary { background: var(--secondary); }
        .btn-secondary:hover:not(:disabled) { background: #185bcc; }
        
        /* Input de carpeta personalizado */
        .folder-input-container {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .folder-input-container:hover {
            border-color: var(--primary);
            background: rgba(35, 134, 54, 0.05);
        }
        
        .folder-input-container i {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }
        
        .folder-input-container p {
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .folder-input-container small {
            color: var(--warning);
            font-size: 0.85rem;
        }
        
        #folderInput { display: none; }
        
        /* Lista de archivos */
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .file-item:last-child { border-bottom: none; }
        
        .file-item i { color: var(--secondary); }
        
        .file-name {
            flex: 1;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }
        
        .file-size {
            color: var(--text-secondary);
            font-size: 0.85rem;
            min-width: 80px;
            text-align: right;
        }
        
        /* Logs */
        .logs-container {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: var(--radius);
            border-left: 4px solid transparent;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
        }
        
        .log-info {
            background: rgba(56, 139, 253, 0.1);
            border-left-color: var(--secondary);
            color: #79c0ff;
        }
        
        .log-success {
            background: rgba(35, 134, 54, 0.1);
            border-left-color: var(--success);
            color: #56d364;
        }
        
        .log-error {
            background: rgba(248, 81, 73, 0.1);
            border-left-color: var(--danger);
            color: #ff7b72;
        }
        
        /* Progress Bar */
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Footer */
        footer {
            margin-top: 40px;
            text-align: center;
            padding: 20px;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .browser-warning {
            background: rgba(210, 153, 34, 0.1);
            border: 1px solid var(--warning);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-upload"></i> PortalHub Creator</h1>
            <p style="color: var(--text-secondary); max-width: 800px; margin: 0 auto;">
                Sube carpetas locales a GitHub manteniendo la estructura completa. Compatible con todos los navegadores modernos.
            </p>
        </header>
        
        <div class="browser-warning" id="browserWarning">
            <i class="fas fa-exclamation-triangle"></i> 
            <strong>Advertencia:</strong> Tu navegador no soporta la selecci√≥n de carpetas nativa. Usando m√©todo alternativo.
        </div>
        
        <main class="app-layout">
            <!-- Panel Izquierdo: Configuraci√≥n -->
            <section>
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-cogs"></i> Configuraci√≥n GitHub</h2>
                    
                    <div class="form-group">
                        <label><i class="fas fa-key"></i> Personal Access Token</label>
                        <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx" 
                               title="Token con permisos 'repo'">
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                            <a href="https://github.com/settings/tokens/new" target="_blank" 
                               style="color: var(--secondary); text-decoration: none;">
                                <i class="fas fa-external-link-alt"></i> Generar nuevo token
                            </a>
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Propietario</label>
                        <input type="text" id="repoOwner" placeholder="tu-usuario-o-organizacion">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-code-branch"></i> Repositorio</label>
                        <input type="text" id="repoName" placeholder="nombre-del-repositorio">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-comment"></i> Mensaje del Commit</label>
                        <input type="text" id="commitMessage" value="üöÄ Upload portalHub structure">
                    </div>
                    
                    <button class="btn" id="saveConfig">
                        <i class="fas fa-save"></i> Guardar Configuraci√≥n
                    </button>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h2 class="card-title"><i class="fas fa-folder"></i> Seleccionar Carpeta</h2>
                    
                    <div class="folder-input-container" id="folderDropArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p><strong>Haz clic aqu√≠ o arrastra carpetas</strong></p>
                        <p>Selecciona una carpeta con todos sus archivos y subcarpetas</p>
                        <small>Nota: En algunos navegadores necesitar√°s seleccionar los archivos manualmente</small>
                    </div>
                    
                    <input type="file" id="folderInput" webkitdirectory multiple>
                    
                    <div id="folderInfo" style="display: none;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i>
                            Carpeta Seleccionada
                        </h3>
                        
                        <div class="file-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                            <div style="background: var(--bg-input); padding: 10px; border-radius: var(--radius); text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);" id="fileCount">0</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">Archivos</div>
                            </div>
                            <div style="background: var(--bg-input); padding: 10px; border-radius: var(--radius); text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--secondary);" id="totalSize">0 B</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">Tama√±o Total</div>
                            </div>
                        </div>
                        
                        <div class="file-list" id="fileList">
                            <!-- Archivos aparecer√°n aqu√≠ -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Panel Derecho: Control y Logs -->
            <section>
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-rocket"></i> Replicar en GitHub</h2>
                    
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progressStatus">Preparando...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary" id="replicateBtn" disabled>
                        <i class="fas fa-cloud-upload-alt"></i> Iniciar Subida a GitHub
                    </button>
                    
                    <button class="btn" style="background: var(--danger); margin-top: 10px; display: none;" id="cancelBtn">
                        <i class="fas fa-stop-circle"></i> Cancelar
                    </button>
                    
                    <div style="margin-top: 30px;">
                        <h3 class="card-title"><i class="fas fa-terminal"></i> Logs de Proceso</h3>
                        <div class="logs-container" id="logsContainer">
                            <div class="log-entry log-info">
                                <span id="currentTime">00:00:00</span> | PortalHub Creator listo
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn" style="padding: 8px 15px; font-size: 0.9rem; background: var(--border);" 
                                    id="clearLogs">
                                <i class="fas fa-trash"></i> Limpiar
                            </button>
                            <button class="btn" style="padding: 8px 15px; font-size: 0.9rem; background: var(--border);" 
                                    id="exportLogs">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h2 class="card-title"><i class="fas fa-info-circle"></i> Instrucciones</h2>
                    
                    <ol style="color: var(--text-secondary); padding-left: 20px; margin-bottom: 20px;">
                        <li style="margin-bottom: 10px;">Consigue un <strong>GitHub PAT</strong> con permisos <code>repo</code></li>
                        <li style="margin-bottom: 10px;">Ingresa tus datos de repositorio</li>
                        <li style="margin-bottom: 10px;">Selecciona una carpeta local</li>
                        <li style="margin-bottom: 10px;">Haz clic en "Iniciar Subida"</li>
                    </ol>
                    
                    <div style="background: rgba(56, 139, 253, 0.1); padding: 15px; border-radius: var(--radius);">
                        <h4 style="color: var(--secondary); margin-bottom: 10px;">
                            <i class="fas fa-exclamation-circle"></i> Nota Importante
                        </h4>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">
                            La estructura de carpetas se mantendr√° dentro de <code>portalHub/</code> en tu repositorio.
                            Todos los archivos se suben en un solo commit at√≥mico.
                        </p>
                    </div>
                </div>
            </section>
        </main>
        
        <footer>
            <p>PortalHub Creator ‚Ä¢ 100% Frontend ‚Ä¢ Compatible con Chrome, Firefox, Edge, Safari</p>
            <p style="margin-top: 5px; font-size: 0.8rem;">
                <i class="fas fa-shield-alt"></i> Seguro: Tu token solo se env√≠a a GitHub API
            </p>
        </footer>
    </div>

    <script>
        // ===== CONFIGURACI√ìN =====
        const GITHUB_API = 'https://api.github.com';
        let files = [];
        let config = {
            token: '',
            owner: '',
            repo: '',
            commitMessage: 'üöÄ Upload portalHub structure'
        };
        let isProcessing = false;
        
        // ===== ELEMENTOS DOM =====
        const elements = {
            githubToken: document.getElementById('githubToken'),
            repoOwner: document.getElementById('repoOwner'),
            repoName: document.getElementById('repoName'),
            commitMessage: document.getElementById('commitMessage'),
            saveConfig: document.getElementById('saveConfig'),
            folderInput: document.getElementById('folderInput'),
            folderDropArea: document.getElementById('folderDropArea'),
            replicateBtn: document.getElementById('replicateBtn'),
            cancelBtn: document.getElementById('cancelBtn'),
            logsContainer: document.getElementById('logsContainer'),
            folderInfo: document.getElementById('folderInfo'),
            fileCount: document.getElementById('fileCount'),
            totalSize: document.getElementById('totalSize'),
            fileList: document.getElementById('fileList'),
            progressContainer: document.getElementById('progressContainer'),
            progressFill: document.getElementById('progressFill'),
            progressStatus: document.getElementById('progressStatus'),
            progressPercent: document.getElementById('progressPercent'),
            clearLogs: document.getElementById('clearLogs'),
            exportLogs: document.getElementById('exportLogs'),
            browserWarning: document.getElementById('browserWarning'),
            currentTime: document.getElementById('currentTime')
        };
        
        // ===== DETECCI√ìN DE NAVEGADOR =====
        function checkBrowserCompatibility() {
            const isChrome = !!window.chrome;
            const hasWebkitDirectory = 'webkitdirectory' in HTMLInputElement.prototype;
            
            if (!hasWebkitDirectory) {
                elements.browserWarning.style.display = 'block';
                addLog('‚ö†Ô∏è Usando m√©todo de selecci√≥n de archivos m√∫ltiples', 'info');
            }
            
            // Intentar usar la API moderna si est√° disponible
            if (window.showDirectoryPicker) {
                setupModernFolderPicker();
            } else {
                setupLegacyFolderPicker();
            }
        }
        
        function setupModernFolderPicker() {
            elements.folderDropArea.innerHTML = `
                <i class="fas fa-folder-open"></i>
                <p><strong>Haz clic para seleccionar carpeta</strong></p>
                <p>Selecciona una carpeta con todos sus archivos</p>
                <small>Usando API moderna del navegador</small>
            `;
            
            elements.folderDropArea.addEventListener('click', async () => {
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    await processModernFolder(dirHandle);
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        addLog(`‚ùå Error: ${error.message}`, 'error');
                    }
                }
            });
        }
        
        function setupLegacyFolderPicker() {
            elements.folderDropArea.addEventListener('click', () => {
                elements.folderInput.click();
            });
            
            // Arrastrar y soltar
            elements.folderDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.folderDropArea.style.borderColor = var('--primary');
                elements.folderDropArea.style.background = 'rgba(35, 134, 54, 0.1)';
            });
            
            elements.folderDropArea.addEventListener('dragleave', () => {
                elements.folderDropArea.style.borderColor = var('--border');
                elements.folderDropArea.style.background = '';
            });
            
            elements.folderDropArea.addEventListener('drop', async (e) => {
                e.preventDefault();
                elements.folderDropArea.style.borderColor = var('--border');
                elements.folderDropArea.style.background = '';
                
                const items = e.dataTransfer.items;
                if (items.length && items[0].webkitGetAsEntry) {
                    await processDroppedItems(items);
                } else {
                    addLog('‚ùå No se pudieron procesar los archivos arrastrados', 'error');
                }
            });
            
            // Input tradicional
            elements.folderInput.addEventListener('change', (e) => {
                processFileList(e.target.files);
            });
        }
        
        // ===== PROCESAMIENTO DE ARCHIVOS =====
        async function processModernFolder(dirHandle, path = '') {
            files = [];
            addLog('üìÅ Procesando carpeta...', 'info');
            
            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file') {
                    const file = await entry.getFile();
                    const filePath = path ? `${path}/${entry.name}` : entry.name;
                    
                    files.push({
                        path: filePath,
                        file: file,
                        size: file.size
                    });
                } else if (entry.kind === 'directory') {
                    await processModernFolder(entry, path ? `${path}/${entry.name}` : entry.name);
                }
            }
            
            updateFileDisplay();
        }
        
        async function processDroppedItems(items) {
            files = [];
            
            for (const item of items) {
                const entry = item.webkitGetAsEntry();
                if (entry) {
                    await scanEntry(entry);
                }
            }
            
            updateFileDisplay();
        }
        
        async function scanEntry(entry, path = '') {
            if (entry.isFile) {
                return new Promise((resolve) => {
                    entry.file((file) => {
                        const filePath = path ? `${path}/${file.name}` : file.name;
                        files.push({
                            path: filePath,
                            file: file,
                            size: file.size
                        });
                        resolve();
                    });
                });
            } else if (entry.isDirectory) {
                const dirReader = entry.createReader();
                
                return new Promise((resolve) => {
                    dirReader.readEntries(async (entries) => {
                        for (const subEntry of entries) {
                            await scanEntry(subEntry, path ? `${path}/${entry.name}` : entry.name);
                        }
                        resolve();
                    });
                });
            }
        }
        
        function processFileList(fileList) {
            files = Array.from(fileList).map(file => ({
                path: file.webkitRelativePath || file.name,
                file: file,
                size: file.size
            }));
            
            updateFileDisplay();
        }
        
        function updateFileDisplay() {
            if (files.length === 0) {
                elements.folderInfo.style.display = 'none';
                addLog('‚ö†Ô∏è No se encontraron archivos', 'warning');
                return;
            }
            
            // Estad√≠sticas
            const totalSize = files.reduce((sum, f) => sum + f.size, 0);
            elements.fileCount.textContent = files.length;
            elements.totalSize.textContent = formatBytes(totalSize);
            
            // Mostrar primeros 20 archivos
            let fileListHTML = '';
            const displayFiles = files.slice(0, 20);
            
            displayFiles.forEach(file => {
                const icon = getFileIcon(file.path);
                fileListHTML += `
                    <div class="file-item">
                        <i class="fas ${icon}"></i>
                        <div class="file-name">${file.path}</div>
                        <div class="file-size">${formatBytes(file.size)}</div>
                    </div>
                `;
            });
            
            if (files.length > 20) {
                fileListHTML += `
                    <div class="file-item" style="justify-content: center; color: var(--text-secondary);">
                        ... y ${files.length - 20} archivos m√°s
                    </div>
                `;
            }
            
            elements.fileList.innerHTML = fileListHTML;
            elements.folderInfo.style.display = 'block';
            
            addLog(`‚úÖ ${files.length} archivos cargados (${formatBytes(totalSize)})`, 'success');
            updateUIState();
        }
        
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'js': 'fa-js',
                'html': 'fa-html5',
                'css': 'fa-css3',
                'json': 'fa-code',
                'md': 'fa-markdown',
                'txt': 'fa-file-alt',
                'py': 'fa-python',
                'jpg': 'fa-file-image',
                'png': 'fa-file-image',
                'gif': 'fa-file-image',
                'pdf': 'fa-file-pdf',
                'zip': 'fa-file-archive',
                'mp3': 'fa-file-audio',
                'mp4': 'fa-file-video'
            };
            return icons[ext] || 'fa-file';
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ===== LOGS =====
        function addLog(message, type = 'info') {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span>${timeString}</span> | ${message}`;
            
            elements.logsContainer.prepend(logEntry);
            elements.currentTime.textContent = timeString;
            
            // Limitar logs a 100
            const logs = elements.logsContainer.querySelectorAll('.log-entry');
            if (logs.length > 100) {
                logs[logs.length - 1].remove();
            }
        }
        
        // ===== GITHUB API =====
        async function githubRequest(endpoint, options = {}) {
            const url = `${GITHUB_API}${endpoint}`;
            const headers = {
                'Authorization': `token ${config.token}`,
                'Accept': 'application/vnd.github.v3+json',
                'User-Agent': 'PortalHub-Creator',
                ...options.headers
            };
            
            const response = await fetch(url, { ...options, headers });
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(`GitHub API ${response.status}: ${error.message || response.statusText}`);
            }
            
            return response.json();
        }
        
        async function uploadToGitHub() {
            if (isProcessing || files.length === 0) return;
            
            isProcessing = true;
            updateUIState();
            elements.progressContainer.style.display = 'block';
            
            try {
                // Validar configuraci√≥n
                if (!config.token || !config.owner || !config.repo) {
                    throw new Error('Configuraci√≥n incompleta');
                }
                
                // 1. Obtener √∫ltimo commit
                updateProgress(10, 'Conectando con GitHub...');
                let parentSha;
                try {
                    const ref = await githubRequest(`/repos/${config.owner}/${config.repo}/git/refs/heads/main`);
                    parentSha = ref.object.sha;
                    addLog('‚úÖ SHA del commit padre obtenido', 'success');
                } catch (error) {
                    try {
                        const ref = await githubRequest(`/repos/${config.owner}/${config.repo}/git/refs/heads/master`);
                        parentSha = ref.object.sha;
                        addLog('‚úÖ SHA del commit padre obtenido (rama master)', 'success');
                    } catch (e) {
                        throw new Error('No se pudo encontrar rama main/master. ¬øEl repositorio existe?');
                    }
                }
                
                // 2. Crear blobs para cada archivo
                updateProgress(20, 'Preparando archivos...');
                const tree = [];
                
                for (let i = 0; i < Math.min(files.length, 100); i++) { // L√≠mite: 100 archivos
                    const file = files[i];
                    updateProgress(20 + (i / Math.min(files.length, 100)) * 50, 
                                 `Procesando archivo ${i+1}/${Math.min(files.length, 100)}...`);
                    
                    try {
                        // Leer contenido
                        let content;
                        if (file.file.type.startsWith('text/') || 
                            file.path.match(/\.(txt|md|js|html|css|json|py|java|c|cpp|cs|php|rb|go|rs|swift)$/i)) {
                            content = await readFileAsText(file.file);
                        } else {
                            content = await readFileAsBase64(file.file);
                        }
                        
                        // Crear blob en GitHub
                        const blob = await githubRequest(`/repos/${config.owner}/${config.repo}/git/blobs`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                content: content,
                                encoding: file.file.type.startsWith('text/') ? 'utf-8' : 'base64'
                            })
                        });
                        
                        tree.push({
                            path: `portalHub/${file.path}`,
                            mode: '100644',
                            type: 'blob',
                            sha: blob.sha
                        });
                        
                        addLog(`‚úì ${file.path}`, 'info');
                        
                    } catch (error) {
                        addLog(`‚ö†Ô∏è Error con ${file.path}: ${error.message}`, 'warning');
                    }
                }
                
                if (tree.length === 0) {
                    throw new Error('No se pudo procesar ning√∫n archivo');
                }
                
                // 3. Crear tree
                updateProgress(80, 'Creando √°rbol de archivos...');
                const treeResponse = await githubRequest(`/repos/${config.owner}/${config.repo}/git/trees`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tree: tree })
                });
                
                addLog(`‚úÖ √Årbol creado con ${tree.length} archivos`, 'success');
                
                // 4. Crear commit
                updateProgress(90, 'Creando commit...');
                const commit = await githubRequest(`/repos/${config.owner}/${config.repo}/git/commits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: config.commitMessage,
                        tree: treeResponse.sha,
                        parents: [parentSha]
                    })
                });
                
                addLog('‚úÖ Commit creado', 'success');
                
                // 5. Actualizar referencia
                updateProgress(95, 'Actualizando rama...');
                try {
                    await githubRequest(`/repos/${config.owner}/${config.repo}/git/refs/heads/main`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sha: commit.sha })
                    });
                } catch (error) {
                    await githubRequest(`/repos/${config.owner}/${config.repo}/git/refs/heads/master`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sha: commit.sha })
                    });
                }
                
                updateProgress(100, '¬°Completado!');
                addLog('üéâ ¬°Estructura portalHub subida exitosamente!', 'success');
                addLog(`üîó https://github.com/${config.owner}/${config.repo}/tree/main/portalHub`, 'info');
                
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                updateProgress(0, `Error: ${error.message}`);
            } finally {
                isProcessing = false;
                updateUIState();
                setTimeout(() => {
                    elements.progressContainer.style.display = 'none';
                }, 3000);
            }
        }
        
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function updateProgress(percent, status) {
            elements.progressFill.style.width = `${percent}%`;
            elements.progressStatus.textContent = status;
            elements.progressPercent.textContent = `${Math.round(percent)}%`;
        }
        
        // ===== UI STATE =====
        function updateUIState() {
            const hasConfig = config.token && config.owner && config.repo;
            const hasFiles = files.length > 0;
            
            elements.replicateBtn.disabled = !hasConfig || !hasFiles || isProcessing;
            
            if (isProcessing) {
                elements.replicateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                elements.cancelBtn.style.display = 'block';
            } else {
                elements.replicateBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Iniciar Subida a GitHub';
                elements.cancelBtn.style.display = 'none';
            }
        }
        
        function saveConfig() {
            config = {
                token: elements.githubToken.value.trim(),
                owner: elements.repoOwner.value.trim(),
                repo: elements.repoName.value.trim(),
                commitMessage: elements.commitMessage.value.trim() || 'üöÄ Upload portalHub structure'
            };
            
            localStorage.setItem('portalhub_config', JSON.stringify(config));
            addLog('‚úÖ Configuraci√≥n guardada', 'success');
            updateUIState();
        }
        
        function loadConfig() {
            const saved = localStorage.getItem('portalhub_config');
            if (saved) {
                try {
                    config = JSON.parse(saved);
                    elements.githubToken.value = config.token;
                    elements.repoOwner.value = config.owner;
                    elements.repoName.value = config.repo;
                    elements.commitMessage.value = config.commitMessage;
                    addLog('‚öôÔ∏è Configuraci√≥n cargada', 'info');
                } catch (error) {
                    console.error('Error loading config:', error);
                }
            }
        }
        
        // ===== INICIALIZACI√ìN =====
        function init() {
            addLog('üöÄ PortalHub Creator iniciado', 'success');
            
            // Cargar configuraci√≥n
            loadConfig();
            
            // Detectar compatibilidad
            checkBrowserCompatibility();
            
            // Event listeners
            elements.saveConfig.addEventListener('click', saveConfig);
            elements.replicateBtn.addEventListener('click', uploadToGitHub);
            elements.cancelBtn.addEventListener('click', () => {
                isProcessing = false;
                updateUIState();
                addLog('‚èπÔ∏è Proceso cancelado', 'warning');
            });
            
            elements.clearLogs.addEventListener('click', () => {
                elements.logsContainer.innerHTML = '';
                addLog('üìã Logs limpiados', 'info');
            });
            
            elements.exportLogs.addEventListener('click', () => {
                const logs = Array.from(elements.logsContainer.querySelectorAll('.log-entry'))
                    .map(log => log.textContent)
                    .join('\n');
                
                const blob = new Blob([logs], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `logs-${new Date().toISOString().slice(0,10)}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                addLog('üíæ Logs exportados', 'success');
            });
            
            // Auto-save
            ['githubToken', 'repoOwner', 'repoName', 'commitMessage'].forEach(id => {
                document.getElementById(id).addEventListener('change', saveConfig);
            });
            
            // Actualizar hora
            setInterval(() => {
                const now = new Date();
                elements.currentTime.textContent = now.toLocaleTimeString('es-ES', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }, 1000);
        }
        
        // Iniciar
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
